<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShipStation Monthly Orders Dashboard</title>
  <link rel="stylesheet" href="main.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .orders-header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: var(--shadow-xl);
      margin-bottom: 30px;
      text-align: center;
      border: 4px solid var(--tan-dark);
    }
    
    .orders-header h1 {
      color: var(--tan-dark);
      margin-bottom: 10px;
    }
    
    .orders-controls {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow-lg);
      margin-bottom: 25px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      border: 3px solid var(--tan-dark);
    }
    
    .orders-controls label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1em;
    }
    
    .orders-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .calendar-view {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: var(--shadow-lg);
      display: none;
      border: 3px solid var(--tan-dark);
    }
    
    .calendar-view.active {
      display: block;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .month-card {
      background: linear-gradient(135deg, var(--tan-dark) 0%, var(--tan-darker) 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .month-card.current-month {
      background: linear-gradient(135deg, var(--tan-light) 0%, var(--tan-medium) 100%);
      border: 3px solid #fff;
      box-shadow: var(--shadow-xl);
    }
    
    .month-card.current-month .month-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.3);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .month-card:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }
    
    .month-name {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .chart-view {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: var(--shadow-lg);
      border: 3px solid var(--tan-dark);
      display: none;
      max-height: 550px;
    }
    
    .chart-view.active {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 30px;
    }
    
    .chart-section {
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: 100%;
    }
    
    .chart-stats-sidebar {
      background: var(--card-bg-end);
      padding: 20px;
      border-radius: 10px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      border: 2px solid var(--tan-dark);
      align-content: start;
    }
    
    .chart-stat-item {
      text-align: center;
    }
    
    .chart-stat-label {
      font-size: 0.9em;
      color: var(--tan-dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .chart-stat-value {
      font-size: 2em;
      font-weight: bold;
      color: var(--tan-darker);
    }
    
    .chart-wrapper {
      position: relative;
      height: 420px;
      width: 100%;
      flex-shrink: 0;
    }
    
    .view-btn {
      padding: 10px 20px;
      background: white;
      border: 2px solid var(--tan-light);
      color: var(--tan-dark);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }
    
    .view-btn.active {
      background: var(--tan-light);
      color: white;
      border-color: var(--tan-light);
    }
    
    .view-btn:hover {
      background: var(--card-bg-end);
    }
    
    @media (max-width: 768px) {
      .chart-view.active {
        grid-template-columns: 1fr;
        max-height: none;
      }
      
      .chart-wrapper {
        height: 300px;
      }
      
      .calendar-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="orders-header">
      <h1>Rowe Casa Organics Orders Overview</h1>
    </div>

    <div class="orders-controls">
      <label>View Year:</label>
      <select id="yearFilter" class="btn-secondary">
        <option value="all">All Years</option>
      </select>
      
      <button onclick="jumpToCurrentMonth()" class="btn-primary">ðŸ“… Current Month</button>
      <button onclick="refreshData()" class="btn-secondary">ðŸ”„ Refresh Data</button>
      
      <div class="view-toggle" style="margin-left: auto;">
        <button class="view-btn active" onclick="switchView('calendar')">ðŸ“… Calendar</button>
        <button class="view-btn" onclick="switchView('chart')">ðŸ“ˆ Chart</button>
      </div>
    </div>

    <div id="loading" class="loading">Loading data</div>

    <div id="statsGrid" class="orders-stats-grid" style="display: none;"></div>

    <div id="calendarView" class="calendar-view active">
      <div class="calendar-header">
        <h2 id="calendarTitle">All Months</h2>
      </div>
      <div id="calendarGrid" class="calendar-grid"></div>
    </div>

    <div id="chartView" class="chart-view">
      <div class="chart-section">
        <h2>Monthly Orders Trends</h2>
        <div class="chart-wrapper">
          <canvas id="ordersChart"></canvas>
        </div>
      </div>
      <div id="chartStats" class="chart-stats-sidebar"></div>
    </div>
  </div>

  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1fuXYhSNqwFA7nB9k3Nqd_Epp1BV8ZYlTi9JRm98KtNU';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
    
    let allData = [];
    let currentView = 'calendar';
    let chart = null;
    const currentDate = new Date();
    const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
    const currentYear = currentDate.getFullYear();
    
    async function loadData() {
      try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        allData = lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
          const obj = {};
          headers.forEach((h, i) => {
            obj[h] = values[i] || '';
          });
          return obj;
        }).filter(row => row['Month/Year'] && row['Month/Year'] !== '');
        
        console.log('Loaded data:', allData);
        
        populateYearFilter();
        renderCalendar();
        updateStats();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('statsGrid').style.display = 'grid';
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').innerHTML = 'Error loading data. Please check console.';
      }
    }
    
    function populateYearFilter() {
      const years = [...new Set(allData.map(d => d['Month/Year'].split(' ')[1]))];
      const filter = document.getElementById('yearFilter');
      filter.innerHTML = '<option value="all">All Years</option>';
      years.forEach(year => {
        filter.innerHTML += `<option value="${year}">${year}</option>`;
      });
      
      filter.addEventListener('change', () => {
        renderCalendar();
        if (currentView === 'chart') renderChart();
      });
    }
    
    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      
      const selectedYear = document.getElementById('yearFilter').value;
      const filteredData = selectedYear === 'all' 
        ? allData 
        : allData.filter(d => d['Month/Year'].includes(selectedYear));
      
      filteredData.forEach(row => {
        const card = document.createElement('div');
        card.className = 'month-card';
        
        if (row['Month/Year'] === `${currentMonth} ${currentYear}`) {
          card.classList.add('current-month');
          card.innerHTML = '<div class="month-badge">Current</div>';
        }
        
        const totalOrders = parseInt(row['Grand Total'] || 0);
        
        card.innerHTML += `
          <div class="month-name">${row['Month/Year']}</div>
          <div style="font-size: 2.5em; font-weight: bold; margin: 10px 0;">${totalOrders.toLocaleString()}</div>
          <div style="opacity: 0.9;">Total Orders</div>
        `;
        
        card.onclick = () => showMonthDetails(row);
        grid.appendChild(card);
      });
    }
    
    function updateStats() {
      const grid = document.getElementById('statsGrid');
      const totalOrders = allData.reduce((sum, row) => sum + parseInt(row['Grand Total'] || 0), 0);
      const avgPerMonth = totalOrders / allData.length;
      
      const thisMonth = allData.find(d => d['Month/Year'] === `${currentMonth} ${currentYear}`);
      const thisMonthTotal = thisMonth ? parseInt(thisMonth['Grand Total'] || 0) : 0;
      
      grid.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">Total Orders</div>
          <div class="stat-value">${totalOrders.toLocaleString()}</div>
          <div class="stat-subtitle">All time</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average Per Month</div>
          <div class="stat-value">${Math.round(avgPerMonth).toLocaleString()}</div>
          <div class="stat-subtitle">Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">This Month</div>
          <div class="stat-value">${thisMonthTotal.toLocaleString()}</div>
          <div class="stat-subtitle">${currentMonth} ${currentYear}</div>
        </div>
      `;
    }
    
    function switchView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(view === 'calendar' ? 'Calendar' : 'Chart'));
      });
      
      document.getElementById('calendarView').classList.toggle('active', view === 'calendar');
      document.getElementById('chartView').classList.toggle('active', view === 'chart');
      
      if (view === 'chart') renderChart();
    }
    
    function renderChart() {
      const selectedYear = document.getElementById('yearFilter').value;
      const filteredData = selectedYear === 'all' 
        ? allData 
        : allData.filter(d => d['Month/Year'].includes(selectedYear));
      
      const labels = filteredData.map(d => d['Month/Year']);
      const data = filteredData.map(d => parseInt(d['Grand Total'] || 0));
      
      const ctx = document.getElementById('ordersChart');
      if (chart) chart.destroy();
      
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Orders',
            data: data,
            borderColor: '#d2b48c',
            backgroundColor: 'rgba(210, 180, 140, 0.1)',
            tension: 0.3,
            fill: true,
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: { color: '#8b7355' }
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: { color: '#a0906f' }
            },
            x: { 
              ticks: { color: '#a0906f', maxRotation: 45, minRotation: 45 }
            }
          }
        }
      });
      
      const total = data.reduce((a, b) => a + b, 0);
      const avg = Math.round(total / data.length);
      const max = Math.max(...data);
      
      document.getElementById('chartStats').innerHTML = `
        <div class="chart-stat-item">
          <div class="chart-stat-label">Total</div>
          <div class="chart-stat-value">${total.toLocaleString()}</div>
        </div>
        <div class="chart-stat-item">
          <div class="chart-stat-label">Average</div>
          <div class="chart-stat-value">${avg.toLocaleString()}</div>
        </div>
        <div class="chart-stat-item">
          <div class="chart-stat-label">Peak</div>
          <div class="chart-stat-value">${max.toLocaleString()}</div>
        </div>
      `;
    }
    
    function showMonthDetails(row) {
      const modal = document.getElementById('detailModal');
      const content = document.getElementById('modalContent');
      
      let html = `<h2>${row['Month/Year']}</h2><table><thead><tr><th>Store</th><th>Orders</th></tr></thead><tbody>`;
      
      Object.keys(row).forEach(key => {
        if (key !== 'Month/Year' && key !== 'Grand Total' && row[key]) {
          html += `<tr><td>${key}</td><td>${parseInt(row[key]).toLocaleString()}</td></tr>`;
        }
      });
      
      html += `<tr style="font-weight: bold; background: var(--tan-light); color: white;">
        <td>TOTAL</td><td>${parseInt(row['Grand Total']).toLocaleString()}</td></tr></tbody></table>`;
      
      content.innerHTML = html;
      modal.classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }
    
    function jumpToCurrentMonth() {
      const thisYear = currentDate.getFullYear().toString();
      document.getElementById('yearFilter').value = thisYear;
      renderCalendar();
      
      setTimeout(() => {
        const currentCard = document.querySelector('.month-card.current-month');
        if (currentCard) {
          currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }
    
    function refreshData() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('statsGrid').style.display = 'none';
      loadData();
    }
    
    loadData();
  </script>
</body>
</html>
